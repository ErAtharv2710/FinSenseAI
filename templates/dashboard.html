<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSense - Financial Literacy for Youth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

    <!-- Authentication Section -->
    <section id="auth-section" class="active-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="logo-area">
                    <i class="fas fa-wallet logo-icon"></i>
                    <h1>FinSense</h1>
                    <p>Master Your Money, Master Your Life</p>
                </div>

                <div class="auth-tabs">
                    <button class="tab-btn active" id="tab-signin">Sign In</button>
                    <button class="tab-btn" id="tab-create">Create Account</button>
                </div>

                <!-- Sign In Form -->
                <form id="sign-in-form" class="auth-form active" onsubmit="submitSignInForm(event)">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                        <span class="error-msg" id="login-email-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="login-password" placeholder="Min 8 chars" required minlength="8">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <span class="error-msg" id="login-password-error"></span>
                    </div>
                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="remember-device">
                            <span class="checkmark"></span>
                            Remember this device
                        </label>
                        <a href="#" class="forgot-pass">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Sign In</button>
                </form>

                <!-- Create Account Form -->
                <form id="create-account-form" class="auth-form" onsubmit="submitCreateAccountForm(event)">
                    <div class="form-group">
                        <label for="reg-name">Full Name</label>
                        <input type="text" id="reg-name" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-display-name">Display Name</label>
                        <input type="text" id="reg-display-name" placeholder="Nickname for leaderboard" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-email">Email</label>
                        <input type="email" id="reg-email" placeholder="john@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-mobile">Mobile Number</label>
                        <input type="tel" id="reg-mobile" placeholder="+1 234 567 8900" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-pass">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="reg-pass" placeholder="Create password" required minlength="8">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reg-confirm-pass">Confirm Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="reg-confirm-pass" placeholder="Confirm password" required minlength="8">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <span class="error-msg" id="reg-error-msg"></span>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create My FinSense Account</button>
                </form>
            </div>
        </div>
    </section>

    <style>
        .auth-form { display: none; transition: opacity 0.3s ease; }
        .auth-form.active { display: block; opacity: 1; }
        .tab-btn.active { background-color: #4a74d9; color: white; }
        .hidden { display: none; }
    </style>

    <!-- Main App Shell -->
    <div id="app-shell" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="nav-left">
                <button id="mobile-menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <div class="nav-brand">
                    <i class="fas fa-wallet logo-icon-sm"></i>
                    <span>FinSense</span>
                </div>
            </div>

            <div class="nav-center">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search topics, quests...">
                </div>
            </div>

            <div class="nav-right">
                <div class="user-dropdown-container">
                    <div class="user-mini-profile" onclick="toggleUserDropdown()">
                        <img src="" alt="User" id="nav-user-avatar">
                        <span class="nav-user-name" id="nav-user-name"></span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="user-dropdown" class="dropdown-menu hidden">
                        <a href="#" onclick="openUserProfile()"><i class="fas fa-user"></i> Profile</a>
                        <a href="#" onclick="goToSection('settings')"><i class="fas fa-cog"></i> Settings</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" onclick="handleSignOut()" class="text-danger"><i class="fas fa-sign-out-alt"></i>
                            Sign Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <ul class="nav-links">
                    <li onclick="openDashboard()" class="active" id="nav-dashboard"><i class="fas fa-home"></i>
                        <span>Dashboard</span></li>
                    <li onclick="openLearningAcademy()" id="nav-academy"><i class="fas fa-graduation-cap"></i>
                        <span>Learning Academy</span></li>
                    <li onclick="openDailyQuests()" id="nav-quests"><i class="fas fa-scroll"></i> <span>Daily Quests</span></li>
                    <li onclick="openArcadeGames()" id="nav-arcade"><i class="fas fa-gamepad"></i> <span>Arcade Games</span></li>
                    <li onclick="openMarketLab()" id="nav-market"><i class="fas fa-chart-line"></i> <span>Market Lab</span></li>
                    <li onclick="openFinSenseCoach()" id="nav-coach"><i class="fas fa-robot"></i> <span>FinSense Coach</span></li>
                    <li onclick="openTeamArena()" id="nav-arena"><i class="fas fa-fist-raised"></i> <span>Team Arena</span></li>
                    <li onclick="openHallOfFame()" id="nav-hall"><i class="fas fa-trophy"></i> <span>Hall of Fame</span></li>
                    <li onclick="goToSection('settings')" id="nav-settings"><i class="fas fa-cog"></i> <span>Settings</span></li>
                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="content-area">

                <!-- Dashboard Section -->
                <section id="dashboard" class="content-section active">
                    <div class="dashboard-header">
                        <h2>Dashboard</h2>
                        <p class="date-display">Today is <span id="current-date"></span></p>
                    </div>
                    <div class="dashboard-grid">
                        <div class="card ai-card" id="aiSummaryBlock">
                            <div class="card-header">
                                <h3><i class="fas fa-lightbulb accent-icon"></i> Today's Money Tip</h3>
                            </div>
                            <div class="card-body">
                                <p id="dailyAdviceText">"Compound interest is the eighth wonder of the world..."</p>
                            </div>
                        </div>
                        <div class="card" id="spendingSnapshot">
                            <div class="card-header"><h3>Spending Snapshot</h3></div>
                            <div class="card-body">
                                <div class="progress-group">
                                    <div class="progress-label"><span>Needs</span> <span>50%</span></div>
                                    <div class="progress-bar">
                                        <div class="fill" style="width: 50%; background-color: #3B82F6;"></div>
                                    </div>
                                </div>
                                <div class="progress-group">
                                    <div class="progress-label"><span>Wants</span> <span>30%</span></div>
                                    <div class="progress-bar">
                                        <div class="fill" style="width: 30%; background-color: #F59E0B;"></div>
                                    </div>
                                </div>
                                <div class="progress-group">
                                    <div class="progress-label"><span>Savings</span> <span>20%</span></div>
                                    <div class="progress-bar">
                                        <div class="fill" style="width: 20%; background-color: #10B981;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card" id="questProgress">
                            <div class="card-header"><h3>Quest Progress</h3></div>
                            <div class="card-body">
                                <h4>Current: Budget Master</h4>
                                <div class="progress-bar-lg">
                                    <div class="fill" style="width: 75%;"></div>
                                </div>
                                <p class="mt-2 text-muted">75% Complete</p>
                                <div class="recommendation-box" id="aiRecommendationList">
                                    <p><strong>Next Step:</strong> Review your weekly expenses in the Academy.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- User Profile Section -->
                <section id="user-profile" class="content-section">
                    <h2>User Profile</h2>
                    <div class="profile-layout">
                        <div class="card profile-sidebar">
                            <div class="profile-avatar-lg">
                                <img src="" alt="Profile" id="profile-avatar">
                            </div>
                            <h3 class="text-center" id="profile-display-name"></h3>
                            <p class="text-center text-muted" id="profile-email"></p>
                            <hr>
                            <div class="profile-stats-list">
                                <div class="stat-row"><span>Age Group:</span> <span id="profile-age">18-24</span></div>
                                <div class="stat-row"><span>City:</span> <span id="profile-city">New York</span></div>
                            </div>
                        </div>
                        <div class="card profile-content">
                            <h3>Edit Profile</h3>
                            <form onsubmit="updateUserProfile(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Display Name</label>
                                        <input type="text" id="edit-display-name">
                                    </div>
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" id="edit-city">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Age Group</label>
                                    <select id="edit-age">
                                        <option>Under 18</option>
                                        <option>18-24</option>
                                        <option>25-34</option>
                                    </select>
                                </div>

                                <div class="settings-toggles">
                                    <label class="switch-row">
                                        <span>Email notifications</span>
                                        <input type="checkbox" checked id="toggle-email-notif">
                                    </label>
                                    <label class="switch-row">
                                        <span>Show my profile on leaderboard</span>
                                        <input type="checkbox" checked id="toggle-leaderboard">
                                    </label>
                                </div>

                                <div class="profile-actions">
                                    <button type="submit" class="btn btn-primary">Save Profile Changes</button>
                                    <button type="button" class="btn btn-outline" onclick="startChangePasswordFlow()">Change Password</button>
                                    <button type="button" class="btn btn-danger" onclick="confirmAccountDeletion()">Delete My Account</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- The rest of your sections (Learning Academy, Daily Quests, Arcade, Market Lab, Coach, Team Arena, Hall of Fame, Settings) remain unchanged -->
                <!-- ... -->

            </main>
        </div>
    </div>

    <!-- Modals and Game modal remain unchanged -->
    <!-- ... -->

    <script>
        // ------------------ Firebase Initialization ------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCJNlKOrGxt19Ewv_MTH9XLb-JPlEOZMqI",
            authDomain: "finsenseai-834cf.firebaseapp.com",
            projectId: "finsenseai-834cf",
            storageBucket: "finsenseai-834cf.firebasestorage.app",
            messagingSenderId: "1089787327198",
            appId: "1:1089787327198:web:a847d5d61df1444849c84f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ------------------ Tab Switching ------------------
        const tabSignIn = document.getElementById('tab-signin');
        const tabCreate = document.getElementById('tab-create');
        const signInForm = document.getElementById('sign-in-form');
        const createForm = document.getElementById('create-account-form');

        tabSignIn.addEventListener('click', () => {
            tabSignIn.classList.add('active');
            tabCreate.classList.remove('active');
            signInForm.classList.add('active');
            createForm.classList.remove('active');
        });

        tabCreate.addEventListener('click', () => {
            tabCreate.classList.add('active');
            tabSignIn.classList.remove('active');
            createForm.classList.add('active');
            signInForm.classList.remove('active');
        });

        // ------------------ Password Toggle ------------------
        function togglePasswordVisibility(icon) {
            const input = icon.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye-slash');
        }

        // ------------------ Create Account ------------------
        function submitCreateAccountForm(e) {
            e.preventDefault();

            const name = document.getElementById('reg-name').value;
            const displayName = document.getElementById('reg-display-name').value;
            const email = document.getElementById('reg-email').value;
            const mobile = document.getElementById('reg-mobile').value;
            const password = document.getElementById('reg-pass').value;
            const confirmPass = document.getElementById('reg-confirm-pass').value;

            if (password !== confirmPass) {
                document.getElementById('reg-error-msg').textContent = "Passwords do not match!";
                return;
            } else {
                document.getElementById('reg-error-msg').textContent = "";
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    db.collection('users').doc(user.uid).set({
                        name,
                        displayName,
                        email,
                        mobile,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        alert('Account created successfully!');
                        tabSignIn.click();
                    })
                    .catch((err) => console.error("Firestore Error:", err.message));
                })
                .catch((err) => alert(err.message));
        }

        // ------------------ Sign In ------------------
        function submitSignInForm(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    loadUserData(user.uid);
                })
                .catch((err) => alert(err.message));
        }

        // ------------------ Load User Data ------------------
        function loadUserData(uid) {
            db.collection('users').doc(uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    // Update navbar
                    document.getElementById('nav-user-avatar').src = `https://ui-avatars.com/api/?name=${data.displayName}&background=00C853&color=fff`;
                    document.getElementById('nav-user-name').textContent = data.displayName;

                    // Update profile
                    document.getElementById('profile-avatar').src = `https://ui-avatars.com/api/?name=${data.displayName}&background=00C853&color=fff`;
                    document.getElementById('profile-display-name').textContent = data.displayName;
                    document.getElementById('profile-email').textContent = data.email;
                    document.getElementById('edit-display-name').value = data.displayName;
                }
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
            });
        }

        // ------------------ Auth State Listener ------------------
        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserData(user.uid);
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-shell').classList.add('hidden');
            }
        });

        // ------------------ Sign Out ------------------
        function handleSignOut() {
            auth.signOut().then(() => {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-shell').classList.add('hidden');
            });
        }
    </script>

    <!-- Your existing app.js -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>

</html>
